<div class="flex flex-col items-center min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-700 p-2">

  <!-- PANTALLA INICIAL -->
  @if (!juegoIniciado) {
    <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center">

      <div class="bg-neutral text-neutral-content
                  p-8 rounded-xl shadow-2xl
                  max-w-md text-center">

        <h2 class="text-2xl font-mono text-warning mb-4">
          ACCESO AL LABERINTO
        </h2>

        <p class="text-sm leading-relaxed mb-6">
          Has accedido a un sistema de seguridad antiguo.<br><br>

          El laberinto oculta la <strong>llave maestra</strong> y la salida.<br>
          Algunas celdas contienen trampas el√©ctricas.<br><br>

          <span class="text-warning font-semibold">
            Solo podr√°s escapar si encuentras la llave.
          </span>
        </p>

        <button
          class="btn btn-warning btn-lg w-full"
          (click)="iniciarLaberinto()"
        >
          INICIAR EXPLORACI√ìN
        </button>

      </div>
    </div>
  }


  <!-- Contenedor de notificaciones -->
  <div class="fixed top-4 left-1/2 -translate-x-1/2 flex flex-col items-center gap-2 z-50">
    @for (n of notificaciones(); track n.id) {
      <div
        class="text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2"
        [ngClass]="{
          'bg-green-500': n.tipo === 'success',
          'bg-red-500': n.tipo === 'error',
          'bg-blue-500': n.tipo === 'info',
          'animate-fade-in-out': n.id !== ultimaVictoriaId
        }"
      >

        {{ n.mensaje }}

        <!-- Mostrar bot√≥n Continuar solo para notificaciones de victoria -->
        @if (n.tipo === 'success' && n.id === ultimaVictoriaId) {
          <button class="ml-2 btn btn-xs btn-accent" routerLink="/radio">
            Continuar
          </button>
        }
      </div>
    }
  </div>




  <!-- Contenedor superior: SALIDA y Reiniciar -->
  <div class="w-full max-w-[90vw] md:max-w-[600px]
            flex justify-between items-center mb-4
            bg-gray-800/80 backdrop-blur-md
            rounded-xl px-3 py-2 shadow-lg">
    <div class="badge badge-lg badge-success text-white font-bold shadow-xl
            tracking-wide animate-pulse">
        SALIDA
      </div>

    <button class="btn btn-error btn-sm shadow-md
               hover:scale-105 active:scale-95
               transition-transform duration-150"
            (click)="resetGame()">
      Reiniciar
    </button>

  </div>

  <!-- Contenedor del laberinto -->
  <div class="w-full max-w-[90vw] md:max-w-[600px]">
    <div class="grid w-full" [style.gridTemplateColumns]="'repeat(' + laberinto.length + ', minmax(0, 1fr))'">
      @for (row of laberinto; track $index; let filaIndex = $index) {
        @for (cell of row; track $index; let columnaIndex = $index) {

          <!-- 1. Celda permanentemente err√≥nea (trampa roja) -->
          @if (celdasErroneas()[filaIndex][columnaIndex]) {
            <div class="relative aspect-square w-full bg-red-900 border border-red-600 flex items-center justify-center
              animate-pulse overflow-hidden shadow-md rounded-md trampa-activada">

              <span class="text-[4vw] md:text-2xl">‚ò†Ô∏è</span>
              @if (jugadorPos.x === columnaIndex && jugadorPos.y === filaIndex) {
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-[5vw] md:text-2xl
                  shadow-2xl player-breathe">
                  ü¶ñ
                </div>

              }
            </div>
          }

          <!-- 2. Celdas no visitadas (niebla) -->
          @else if (!visitado()[filaIndex][columnaIndex]
            && !(primeraLlave && llavePos.x === columnaIndex && llavePos.y === filaIndex)) {
            <div class="aspect-square w-full bg-gray-900 border border-gray-700 opacity-90 transition-opacity duration-300"></div>
          }

          <!-- 3. Celdas normales visitadas -->
          @else {
            <div class="relative aspect-square w-full border border-gray-600 shadow-sm rounded-md"
                 [ngClass]="{
                   'bg-gray-700': cell === 1,
                   'bg-gray-800': cell === 0 || cell === TIPO_TRAMPA
                 }">

              <!-- Llave -->
              @if (primeraLlave && llavePos.x === columnaIndex && llavePos.y === filaIndex) {
                @if (haRecogidoLlave) {
                  <div class="llave-wrapper text-[4vw] md:text-xl shadow-lg">
                    <span class="animate-bounce">
                      <span class="llave-encontrada">üóùÔ∏è</span>
                    </span>
                  </div>
                } @else {
                  <div class="llave-wrapper text-[4vw] md:text-xl shadow-lg">
                    <span class="animate-bounce">
                      <span class="llave-pendiente">üîë</span>
                    </span>
                  </div>

                }
              }

              <!-- Meta / salida -->
              @if (metaPos.x === columnaIndex && metaPos.y === filaIndex && haRecogidoLlave){
                <div class="w-full h-full flex items-center justify-center text-[3vw] md:text-xs">
                  <span class="badge badge-success badge-sm font-bold shadow-md meta-victoria">
                    META
                  </span>
                </div>
              }
              @else if (metaPos.x === columnaIndex && metaPos.y === filaIndex && !haRecogidoLlave){
                <div class="w-full h-full flex items-center justify-center text-[3vw] md:text-xs">
                  <span class="badge badge-warning badge-sm font-bold animate-pulse">üîí</span>
                </div>
              }

              <!-- Jugador -->
              @if (jugadorPos.x === columnaIndex && jugadorPos.y === filaIndex){
                <div class="player-breathe absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-[5vw] md:text-2xl shadow-2xl">ü¶ñ</div>
              }
            </div>
          }
        }
      }
    </div>
  </div>

  <!-- Controles m√≥viles -->
  <div class="fixed bottom-6 left-1/2 -translate-x-1/2 flex flex-col items-center gap-2 md:hidden">
    <button class="btn btn-circle shadow-lg active:scale-95 transition-transform" (click)="moverDireccion('up')">‚¨Ü</button>
    <div class="flex gap-2">
      <button class="btn btn-circle shadow-lg active:scale-95 transition-transform" (click)="moverDireccion('left')">‚¨Ö</button>
      <button class="btn btn-circle shadow-lg active:scale-95 transition-transform" (click)="moverDireccion('down')">‚¨á</button>
      <button class="btn btn-circle shadow-lg active:scale-95 transition-transform" (click)="moverDireccion('right')">‚û°</button>
    </div>
  </div>

</div>
